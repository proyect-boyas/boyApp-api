# ğŸ“š DocumentaciÃ³n Completa - WebSocket Streaming API

## ğŸ—ï¸ **Arquitectura del Sistema**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    WebSocket    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    WebSocket    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CÃ¡mara    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚   Servidor  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  App MÃ³vil  â”‚
â”‚   (Stream)  â”‚    /stream      â”‚  Node.js    â”‚    /mobile      â”‚ (Cliente)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ HTTP REST
                                      â–¼
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚   Base de   â”‚
                               â”‚   Datos     â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” **AutenticaciÃ³n y Tokens**

### **Tipos de Tokens:**

| Tipo | Uso | Formato | DuraciÃ³n |
|------|-----|---------|----------|
| **Token CÃ¡mara** | Autenticar cÃ¡maras | JWT | Sin expiraciÃ³n |
| **Token Usuario** | Autenticar app mÃ³vil | JWT | Configurable |

### **Estructura Token CÃ¡mara:**
```json
{
  "camara_id": "camara_001",
  "type": "camera",
  "iat": 1635789123
}
```

### **Estructura Token Usuario:**
```json
{
  "userId": 1,
  "nombre": "Juan PÃ©rez",
  "role": "user",
  "iat": 1635789123,
  "exp": 1635792723
}
```

---

## ğŸŒ **Endpoints WebSocket**

### **1. ğŸ“¹ Endpoint CÃ¡mara - `/stream`**
**PropÃ³sito:** Transmitir video desde cÃ¡maras

**URL:**
```
ws://localhost:3000/stream?token={TOKEN_CAMARA}&cameraId={CAMERA_ID}
```

**ParÃ¡metros:**
| ParÃ¡metro | Tipo | Requerido | DescripciÃ³n |
|-----------|------|-----------|-------------|
| `token` | string | âœ… | Token JWT de la cÃ¡mara |
| `cameraId` | string | âœ… | ID Ãºnico de la cÃ¡mara |

**Mensajes de Entrada (CÃ¡mara â†’ Servidor):**
```javascript
// Formato texto simple (recomendado)
"frame_data_binary_or_base64"

// Formato JSON estructurado
{
  "type": "video_data",
  "frame": "base64_encoded_data",
  "timestamp": 1635789123456
}
```

**Eventos de Salida (Servidor â†’ CÃ¡mara):**
```json
{
  "type": "error",
  "message": "DescripciÃ³n del error"
}
```

---

### **2. ğŸ“± Endpoint MÃ³vil - `/mobile`**
**PropÃ³sito:** Recibir video en app mÃ³vil

**URL:**
```
ws://localhost:3000/mobile?token={TOKEN_USUARIO}&cameraId={CAMERA_ID}
```

**ParÃ¡metros:**
| ParÃ¡metro | Tipo | Requerido | DescripciÃ³n |
|-----------|------|-----------|-------------|
| `token` | string | âœ… | Token JWT del usuario |
| `cameraId` | string | âœ… | ID de cÃ¡mara a visualizar |

**Mensajes de Entrada (Cliente â†’ Servidor):**
```json
// Ping/Pong para mantener conexiÃ³n
{"type": "ping"}

// Cambiar cÃ¡mara en tiempo real
{"type": "change_camera", "cameraId": "nueva_camara_001"}

// Solicitar lista de cÃ¡maras
{"type": "list_cameras"}
```

**Mensajes de Salida (Servidor â†’ Cliente):**

**ConexiÃ³n Establecida:**
```json
{
  "type": "connection_established",
  "cameraId": "camara_001",
  "user": {
    "id": 1,
    "nombre": "Juan PÃ©rez",
    "role": "user"
  },
  "timestamp": 1635789123456,
  "cameraStatus": "online"
}
```

**Frame de Video:**
```json
{
  "type": "video_frame",
  "cameraId": "camara_001",
  "timestamp": 1635789123456,
  "data": "base64_encoded_video_frame"
}
```

**Estado de CÃ¡mara:**
```json
{
  "type": "camera_status",
  "cameraId": "camara_001",
  "status": "online|offline",
  "timestamp": 1635789123456
}
```

**Respuesta Ping:**
```json
{
  "type": "pong",
  "timestamp": 1635789123456
}
```

**Lista de CÃ¡maras:**
```json
{
  "type": "cameras_list",
  "cameras": [
    {
      "cameraId": "camara_001",
      "modelo": "AXIS P3364",
      "fabricante": "Axis",
      "estado": "ACTIVA",
      "url": "rtsp://camara001/stream",
      "online": true
    }
  ],
  "timestamp": 1635789123456
}
```

---

## ğŸ“Š **Endpoints HTTP para Monitoreo**

### **1. â„¹ï¸ InformaciÃ³n del Sistema**
```
GET /api/stream/info
```

**Respuesta:**
```json
{
  "streaming": true,
  "endpoints": {
    "websocket_mobile": "ws://localhost:3000/mobile",
    "websocket_stream": "ws://localhost:3000/stream",
    "status": "http://localhost:3000/api/stream/status",
    "verify_token": "http://localhost:3000/api/stream/verify-camera-token"
  }
}
```

### **2. ğŸ“ˆ Estado en Tiempo Real**
```
GET /api/stream/status
```

**Respuesta:**
```json
{
  "status": "running",
  "connectedCameras": 2,
  "connectedMobileClients": 5,
  "cameras": {
    "camara_001": {
      "connected": true,
      "token": "eyJhbGciOiJ..."
    }
  },
  "mobileClients": [
    {
      "userId": 1,
      "userName": "Juan PÃ©rez",
      "cameraId": "camara_001",
      "connectedAt": "2023-11-02T10:30:00.000Z",
      "connectionActive": true
    }
  ],
  "databaseCameras": [
    {
      "camara_id": "camara_001",
      "modelo": "AXIS P3364",
      "estado": "ACTIVA"
    }
  ],
  "timestamp": "2023-11-02T10:35:23.456Z"
}
```

### **3. âœ… Verificar Token de CÃ¡mara**
```
POST /api/stream/verify-camera-token
```

**Body:**
```json
{
  "token": "eyJhbGciOiJ...",
  "cameraId": "camara_001"
}
```

**Respuesta Exitosa:**
```json
{
  "valid": true,
  "message": "Token vÃ¡lido"
}
```

**Respuesta Error:**
```json
{
  "valid": false,
  "message": "Token invÃ¡lido"
}
```

### **4. ğŸ“‹ Lista de CÃ¡maras Disponibles**
```
GET /api/stream/cameras
```

**Respuesta:**
```json
{
  "success": true,
  "cameras": [
    {
      "id": "camara_001",
      "modelo": "AXIS P3364",
      "fabricante": "Axis",
      "estado": "ACTIVA",
      "url": "rtsp://192.168.1.100/stream",
      "fecha_instalacion": "2023-01-15",
      "fecha_ultimo_mantenimiento": "2023-10-20",
      "created_at": "2023-01-15T08:00:00.000Z"
    }
  ],
  "total": 1
}
```

### **5. ğŸ“Š EstadÃ­sticas del Sistema**
```
GET /api/stream/stats
```

**Respuesta:**
```json
{
  "streaming": {
    "connected_cameras": 2,
    "connected_clients": 5,
    "uptime": 86400
  },
  "database": {
    "total_camaras": 10,
    "camaras_activas": 8,
    "camaras_inactivas": 2
  },
  "server": {
    "timestamp": "2023-11-02T10:35:23.456Z",
    "node_version": "v18.17.0",
    "platform": "linux"
  }
}
```

---

## ğŸ—‚ï¸ **ColecciÃ³n Postman**

```json
{
  "info": {
    "name": "WebSocket Streaming API",
    "description": "API para streaming de video en tiempo real",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "localhost:3000",
      "type": "string"
    },
    {
      "key": "camera_token",
      "value": "TU_TOKEN_CAMARA_AQUI",
      "type": "string"
    },
    {
      "key": "user_token",
      "value": "TU_TOKEN_USUARIO_AQUI",
      "type": "string"
    },
    {
      "key": "camera_id",
      "value": "camara_001",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "ğŸŒ WebSocket Endpoints",
      "item": [
        {
          "name": "ğŸ“¹ Conectar CÃ¡mara (Stream)",
          "request": {
            "url": "ws://{{base_url}}/stream?token={{camera_token}}&cameraId={{camera_id}}",
            "method": "GET",
            "description": "Endpoint para que las cÃ¡maras transmitan video"
          }
        },
        {
          "name": "ğŸ“± Conectar Cliente MÃ³vil",
          "request": {
            "url": "ws://{{base_url}}/mobile?token={{user_token}}&cameraId={{camera_id}}",
            "method": "GET",
            "description": "Endpoint para que los clientes mÃ³viles reciban video"
          }
        }
      ]
    },
    {
      "name": "ğŸ“Š HTTP Monitoring Endpoints",
      "item": [
        {
          "name": "â„¹ï¸ InformaciÃ³n del Sistema",
          "request": {
            "url": "http://{{base_url}}/api/stream/info",
            "method": "GET",
            "description": "Obtener informaciÃ³n de endpoints disponibles"
          }
        },
        {
          "name": "ğŸ“ˆ Estado en Tiempo Real",
          "request": {
            "url": "http://{{base_url}}/api/stream/status",
            "method": "GET",
            "description": "Obtener estado actual de conexiones WebSocket"
          }
        },
        {
          "name": "âœ… Verificar Token CÃ¡mara",
          "request": {
            "url": "http://{{base_url}}/api/stream/verify-camera-token",
            "method": "POST",
            "description": "Validar token de cÃ¡mara antes de conectar",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"token\": \"{{camera_token}}\",\n  \"cameraId\": \"{{camera_id}}\"\n}"
            }
          }
        },
        {
          "name": "ğŸ“‹ Lista de CÃ¡maras",
          "request": {
            "url": "http://{{base_url}}/api/stream/cameras",
            "method": "GET",
            "description": "Obtener lista de cÃ¡maras disponibles"
          }
        },
        {
          "name": "ğŸ“Š EstadÃ­sticas del Sistema",
          "request": {
            "url": "http://{{base_url}}/api/stream/stats",
            "method": "GET",
            "description": "Obtener estadÃ­sticas de uso y rendimiento"
          }
        }
      ]
    },
    {
      "name": "ğŸ”„ Comandos WebSocket",
      "item": [
        {
          "name": "Ping/Pong",
          "request": {
            "description": "Mantener conexiÃ³n activa",
            "body": {
              "mode": "raw",
              "raw": "{\"type\": \"ping\"}"
            }
          }
        },
        {
          "name": "Cambiar CÃ¡mara",
          "request": {
            "description": "Cambiar a otra cÃ¡mara en tiempo real",
            "body": {
              "mode": "raw",
              "raw": "{\"type\": \"change_camera\", \"cameraId\": \"nueva_camara_002\"}"
            }
          }
        },
        {
          "name": "Listar CÃ¡maras",
          "request": {
            "description": "Solicitar lista de cÃ¡maras disponibles",
            "body": {
              "mode": "raw",
              "raw": "{\"type\": \"list_cameras\"}"
            }
          }
        }
      ]
    }
  ]
}
```

---

## ğŸ”§ **CÃ³mo Usar la ColecciÃ³n Postman**

### **1. Importar ColecciÃ³n:**
1. Abre Postman
2. Click **Import** â†’ **Raw Text**
3. Pega el JSON de la colecciÃ³n
4. Click **Import**

### **2. Configurar Variables:**
1. Ve a **Environments**
2. Crea nuevo environment llamado "Streaming API"
3. Agrega las variables:
   - `base_url`: `localhost:3000`
   - `camera_token`: Tu token JWT de cÃ¡mara
   - `user_token`: Tu token JWT de usuario
   - `camera_id`: `camara_001`

### **3. Probar WebSockets:**
1. Selecciona **"ğŸ“¹ Conectar CÃ¡mara"**
2. Click **Connect**
3. EnvÃ­a mensajes en el panel de mensajes

### **4. Probar HTTP Endpoints:**
1. Selecciona cualquier endpoint HTTP
2. Click **Send**
3. Revisa la respuesta

---

## ğŸ› **GuÃ­a de SoluciÃ³n de Problemas**

### **Errores Comunes:**

| Error | Causa | SoluciÃ³n |
|-------|-------|----------|
| `Failed to connect` | Servidor no disponible | Verificar que el servidor estÃ© corriendo |
| `Token invÃ¡lido` | Token incorrecto o expirado | Verificar token con endpoint de verificaciÃ³n |
| `CÃ¡mara no encontrada` | CameraId no existe en BD | Verificar lista de cÃ¡maras disponibles |
| `No llegan frames` | CÃ¡mara desconectada | Verificar conexiÃ³n de la cÃ¡mara |

### **Comandos de DiagnÃ³stico:**
```bash
# Ver logs del servidor
npm run dev

# Ver conexiones activas
curl http://localhost:3000/api/stream/status

# Verificar token
curl -X POST http://localhost:3000/api/stream/verify-camera-token \
  -H "Content-Type: application/json" \
  -d '{"token":"TU_TOKEN","cameraId":"camara_001"}'
```

---

## ğŸ“ **Soporte**

**Para problemas tÃ©cnicos:**
1. Revisa los logs del servidor
2. Verifica el estado con `/api/stream/status`
3. Valida tokens con `/api/stream/verify-camera-token`

**Para preguntas:**
- Revisa esta documentaciÃ³n primero
- Consulta los ejemplos de uso
- Verifica la configuraciÃ³n de tokens

---

**Â¿Necesitas ayuda adicional con algÃºn aspecto especÃ­fico?**




token=   eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjYW1hcmFfaWQiOiJDQU1fMDA0IiwidHlwZSI6ImNhbWVyYSJ9.4VNgNDxZph0P1xMfHL0DEiAWRUJKlnKyU_js7qSYdrs
camara_id=  CAM_004

url-rstp= 